<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=referrer content="no-referrer-when-downgrade">
<title>《高性能MySQL》读书笔记-1-MySQL架构与历史 | itachi's Blog</title>
<meta property="og:title" content="《高性能MySQL》读书笔记-1-MySQL架构与历史 - itachi's Blog">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-07-26T00:00:00+08:00">
<meta property="article:modified_time" content="2021-07-26T00:00:00+08:00">
<meta name=Keywords content="Blog">
<meta name=description content="《高性能MySQL》读书笔记-1-MySQL架构与历史">
<meta name=author content="阿林">
<meta property="og:url" content="https://itachi.xyz/post/high-performance-mysql-1.html">
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=stylesheet href=/css/normalize.css>
<link rel=stylesheet href=/css/style.css>
<script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
</head>
<body>
<header id=header class=clearfix>
<div class=container>
<div class=col-group>
<div class=site-name>
<a id=logo href=https://itachi.xyz>
itachi's Blog
</a>
<p class=description>昨夜梦 今辰你 明日思 | Blog about life and learning.</p>
</div>
<div>
<nav id=nav-menu class=clearfix>
<a class=current href=https://itachi.xyz>首页</a>
<a href=https://itachi.xyz/archives/ title=归档>归档</a>
<a href=https://itachi.xyz/about/ title=关于>关于</a>
<a href=https://itachi.xyz/tags/ title=标签>标签</a>
<a href=https://itachi.xyz/onenote/ title=一言>一言</a>
</nav>
</div>
</div>
</div>
</header>
<div id=body>
<div class=container>
<div class=col-group>
<div class=col-8 id=main>
<div class=res-cons>
<article class=post>
<header>
<h1 class=post-title>《高性能MySQL》读书笔记-1-MySQL架构与历史</h1>
</header>
<date class="post-meta meta-date">
2021年7月26日
</date>
<div class=post-meta>
<span>|</span>
<span class=meta-category><a href=/categories/technology>Technology</a></span>
</div>
<div class=post-meta>
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span>
</div>
<div class=post-content>
<p>了解MySQL的服务架构，理解MySQL的设计。MySQL设计时将查询处理(Query Processing)以及其他系统任务(Server Task)和数据的存储、提取分离开，这样的设计带来了极大的灵活性，可以根据需要选择存储引擎。</p>
<blockquote>
<p>不满足是向上的齿轮。</p>
<p>&mdash; 鲁迅</p>
</blockquote>
<h2 id=1mysql逻辑架构>1.MySQL逻辑架构</h2>
<p>
<img class=mx-auto alt=MySQL逻辑架构 src=https://img.tujidu.com/image/60feb5b1990f1.jpg>
</p>
<ol>
<li><strong>客户端层</strong>：连接处理、授权认证、安全管理等服务</li>
<li><strong>核心服务层</strong>：查询解析、分析，优化、缓存以及内置函数，以及跨存储引擎的功能：存储过程、触发器、视图等</li>
<li><strong>存储引擎层</strong>：存储引擎主要实现MySQL中数据的存储和提取。核心服务通过API与储存引擎进行通信。其中，事务、数据提取这样的操作也是由存储引擎这一层来实现的。同时存储引擎不会解析SQL(InnoDB会解析外键定义)，只是简单的响应核心服务的请求。</li>
<li>MySQL8之后不再内置查询缓存。</li>
</ol>
<h3 id=11-连接管理和安全性>1.1 连接管理和安全性</h3>
<p>连接管理主要负责客户端和MySQL服务的通信：接收请求，传递结果信息。每个客户端连接都会在服务器进程中分配到一个线程，这个连接的查询只会在这个单独的线程中执行。当客户端连接时认证模块会基于用户名、原始主机信息、密码对其连接进行认证，同时也会进行权限校验。</p>
<h3 id=12-优化与执行>1.2 优化与执行</h3>
<p>对于一个查询，MySQL会解析这个查询：创建解析树，并进行重写查询、决定表的读取顺序、选择索引等。</p>
<h2 id=2-并发控制>2. 并发控制</h2>
<h3 id=21-读写锁>2.1 读写锁</h3>
<p>MySQL在两个层面进行并发控制：核心服务层和存储引擎层；并发控制可以由共享锁(读锁)和排他(写锁)锁来解决并发问题：</p>
<ul>
<li>读锁是共享的，多个读操作之间互不影响。</li>
<li>写锁是排他的，一个写操作会阻塞其他的写锁和读锁。</li>
</ul>
<h3 id=22-锁粒度>2.2 锁粒度</h3>
<p>尽量只锁定需要修改的部分数据，理想的状态时只对需要修改的数据片进行精确的锁定。为了平衡锁开销和数据安全性，一般是施加行级锁。</p>
<p><strong>表锁(table lock)</strong>：表锁会锁定整张表，这会阻塞其他用户的所有读写操作。(写锁可以插入到所队列中读锁的前面，读锁却不能插入到写锁之前)</p>
<p><strong>行级锁(row lock)</strong>:InnoDB存储引擎实现了行级锁，因此InnoDB可以最大程度的支持并发处理。当然也带来了很大的开销。当然了，行级锁是存储引擎层自己实现的，核心服务层并不感知。</p>
<h2 id=3-事务>3. 事务</h2>
<p>事务就是一组原子性的SQL查询，或则一个独立的工作单元：要么事务内的这一组语句一起成功，要么一起失败。</p>
<p><strong>原子性(Atomicity)</strong>：一个事务被视为不可分割的最小工作单元，一个事务的所有操作要么全部提交成功，要么全部失败回滚。</p>
<p><strong>一致性(Consistency)</strong>：数据库总是从一个一致的状态到另一个一致的状态。事务没有提交，事务的修改就不会保存到数据库中。</p>
<p><strong>隔离性(isolation)</strong>：<strong>通常来说</strong>，一个事务所作的操作在最终提交之前，对其他事务来说是不可见的。</p>
<p><strong>持久性(durability)</strong>：一旦事务提交，则其所作的修改就会永久的保存到数据库中。</p>
<h3 id=31-隔离级别>3.1 隔离级别</h3>
<ul>
<li>
<p>Read Uncommitted(读未提交)</p>
<p>事务中的修改没有提交对其他事务也是可见的。事务可以读到未提交的数据称为脏读。</p>
</li>
<li>
<p>Read Committed(读已提交)</p>
<p>一个事务从开始到提交之前，所做的任何修改对他其事务是不可见的。这个级别也叫不可重复读(在同一个事务内多次读取相同范围的记录可能不一致)。</p>
</li>
<li>
<p>Repetable Read(可重复读)</p>
<p>repeable read解决了脏读的问题，保证了在<strong>同一个事务</strong>的多次读取同样记录的结果是一致的(在一次事务内)。可重复读不能解决幻读的问题，即同样的事务再次读取同样范围内的记录时，可能会产生幻行(即多次读数据可能不一样)。</p>
</li>
<li>
<p>Serializable(可串行化)</p>
<p>最高的隔离级别，没有并发，强制各个事务串行执行。</p>
</li>
</ul>
<h3 id=32-死锁>3.2 死锁</h3>
<p>两个或多个事务在统一资源上相互占用，并请求对方占用的资源，从而导致恶性循环的问题。多个事务试图以不同顺序锁定资源时、多个事务同时锁定同一个资源就会产生死锁。InnoDB目前处理死锁的方法是<strong>将持有最少行级锁的事务进行回滚</strong>。</p>
<h3 id=33-事务日志>3.3 事务日志</h3>
<p>使用事务日志，存储引擎在修改表的数据时只需要修改内存拷贝，再把该修改行为持久化在硬盘的事务日志中。同时写事务日志时磁盘一小块区域的顺序IO，速度极快。事务日志持久化后，内存中被修改的数据由后台程序慢慢刷回磁盘。</p>
<p>如果数据修改以及记录到事务日志并持久化，此时系统崩溃，存储引擎可以在系统重启之后自动恢复数据。</p>
<h3 id=34-mysql的事务>3.4 MySQL的事务</h3>
<p>MySQL默认采用自动提交事务。如果不是显式的生命一个事务，MySQL会把每一个查询都当作一个事务来操作。MySQL核心服务层部管理事务，由下层的存储引擎来实现，因此一个事务中使用多种存储引擎不可靠的。</p>
<h3 id=35-隐式和显示锁定>3.5 隐式和显示锁定</h3>
<p>InnoDB是两阶段锁定协议，在事务执行过程中，随时都可以执行锁定，锁只有在执行commit或者rollback时才会释放，并且所有的锁都在一瞬间释放。</p>
<h2 id=4-多版本并发控制mvcc>4. 多版本并发控制(MVCC)</h2>
<p>可以认为MVCC是行级锁的一个变种，很多情况下避免了加锁，基本实现了非阻塞读。典型的有乐观并发控制和悲观病啊控制。</p>
<p>MVCC是通过保存某个时间点的快照来实现的，就是说不管执行多久，每个事务看到的数据是一致的。根据事务开始时间不同， 每个事务对同一张表，同一时刻看到的数据可能是不一样的。</p>
<h3 id=41-innodb的实现>4.1 InnoDB的实现</h3>
<p>InnoDB的MVCC是通过在每一行记录的后面保存两个隐藏列来实现。一个列保存了行的创建时间，一个是保存了过期时间(删除时间)，当然存储的不是实际的时间，而是系统版本号(system version number)，每开始一个事务，版本号都会自动递增。事务开始时刻的系统版本号作为事务的版本号，用来和查询到的每行记录的版本号作比较。</p>
<ul>
<li>Select：InnoDB会根据这两个条件来查询：
<ul>
<li>只查找版本号小于或者等于当前事务的数据行，这样可以保证事务读取到的数据要么是在事务开始前就存在的，要么是自己插入或者修改的。</li>
<li>行的删除要么未定义，要么大于当前事务的版本号，这样可以保证读取到的数据在事务开始之前没有被删除</li>
</ul>
</li>
<li>Insert：InnoDB为新插入的每一行数据保存当前的系统版本号为行版本号。</li>
<li>Delete：InnoDB为删除的每一行保存当前的版本号为行删除标识。</li>
<li>Update：InnoDB为插入一条新纪录，保存当前系统版本号为行版本号，同时保存当前系统的版本号到原来的行为行删除标识。</li>
</ul>
<h2 id=5mysql的存储引擎>5.MySQL的存储引擎</h2>
<p>InnoDB采用MVCC支持高并发，默认的隔离级别是Repetable read，通过间隙锁来防止幻读。同时InnoDB是基于聚簇索引建立的。具体的内容阅读到后面章节再细写。</p>
</div>
<div class=post-archive>
<ul class=post-copyright>
<li><strong>原文作者：</strong><a rel=author href=https://itachi.xyz>阿林</a></li>
<li style=word-break:break-all><strong>原文链接：</strong><a href=https://itachi.xyz/post/high-performance-mysql-1.html>https://itachi.xyz/post/high-performance-mysql-1.html</a></li>
<li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
</ul>
</div>
<br>
<div class=post-archive>
</div>
<div class="post-meta meta-tags">
<ul class=clearfix>
<li><a href=/tags/%E9%AB%98%E6%80%A7%E8%83%BDmysql>高性能MySQL</a></li>
<li><a href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0>读书笔记</a></li>
</ul>
</div>
</article>
<div id=gitalk-container></div>
<link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css>
<script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script>
<script>var gitalk=new Gitalk({id:decodeURI(window.location.pathname),clientID:'30ffb17e5ccaa5f1830e',clientSecret:'67ba9ccd9df5c8f402f46b2462f09d644219c04f',repo:'itachi1912.github.io',owner:'itachi1912',admin:['itachi1912'],labels:['gitment'],perPage:25});gitalk.render('gitalk-container')</script>
</div>
</div>
<div id=secondary>
<section class=widget>
<form id=search action=https://itachi.xyz/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1>
<input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://itachi.xyz>
<button type=submit class="submit icon-search"></button>
</form>
</section>
<section class=widget>
<h3 class=widget-title><a href=/categories/>分类</a></h3>
<ul class=widget-list>
<li><a href=https://itachi.xyz/categories/life/>Life (7)</a></li>
<li><a href=https://itachi.xyz/categories/technology/>Technology (12)</a></li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title>最近文章</h3>
<ul class=widget-list>
<li>
<a href=https://itachi.xyz/post/mount-aliyun-disk-to-local.html title=把阿里云盘挂载到本地使用>把阿里云盘挂载到本地使用</a>
</li>
<li>
<a href=https://itachi.xyz/post/get-offer-01.html title=剑指offer计划>剑指offer计划</a>
</li>
<li>
<a href=https://itachi.xyz/post/no-title-about-996.html title=无题>无题</a>
</li>
<li>
<a href=https://itachi.xyz/post/lks-inspiration.html title=观看@-Lks-视频的启示>观看@-Lks-视频的启示</a>
</li>
<li>
<a href=https://itachi.xyz/post/dp-observer-pattern.html title="<设计模式>-观察者模式">&lt;设计模式>-观察者模式</a>
</li>
<li>
<a href=https://itachi.xyz/post/dp-strategy-pattern.html title="<设计模式>-策略模式">&lt;设计模式>-策略模式</a>
</li>
<li>
<a href=https://itachi.xyz/post/powerful-learning.html title=高效学习的几点建议>高效学习的几点建议</a>
</li>
<li>
<a href=https://itachi.xyz/post/high-performance-mysql-4.html title=《高性能MySQL》读书笔记-4-创建高性能索引1>《高性能MySQL》读书笔记-4-创建高性能索引1</a>
</li>
<li>
<a href=https://itachi.xyz/post/high-performance-mysql-3.html title=《高性能MySQL》读书笔记-3-Schema与数据类型优化2>《高性能MySQL》读书笔记-3-Schema与数据类型优化2</a>
</li>
<li>
<a href=https://itachi.xyz/post/high-performance-mysql-2.html title=《高性能MySQL》读书笔记-2-Schema与数据类型优化1>《高性能MySQL》读书笔记-2-Schema与数据类型优化1</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title>友情链接</h3>
<ul class=widget-list>
<li>
<a target=_blank href=https://www.acdiao.com title=AC的简单博客>AC的简单博客</a>
</li>
<li>
<a target=_blank href=https://img.tujidu.com title=AC大佬的图床>AC大佬的图床</a>
</li>
<li>
<a target=_blank href=https://blog.cetcweb.cn/ title=记录实验过程>记录实验过程</a>
</li>
<li>
<a target=_blank href=https://qitablog.com/ title=奇它博客>奇它博客</a>
</li>
<li>
<a target=_blank href=http://laihongquan.com/ title=Ezio>Ezio</a>
</li>
<li>
<a target=_blank href=https://luckly.work/ title=早起的年轻人>早起的年轻人</a>
</li>
<li>
<a target=_blank href=https://geshanzsq.com title=格姗知识圈>格姗知识圈</a>
</li>
</ul>
</section>
<section class=widget>
<h3 class=widget-title>其它</h3>
<ul class=widget-list>
<li><a href=https://itachi.xyz/index.xml>文章 RSS</a></li>
</ul>
</section>
</div>
</div>
<footer id=footer>
<div style=font-size:.7em>
Powered by <a href=https://gohugo.io/ target=_black rel=nofollow>Hugo</a>
and
Theme Based On <a href=https://www.flysnow.org/ target=_black>飞雪无情</a>
</div>
<br>
<div style=font-size:.7em>
&copy; 2021 Made with <span style=color:red>❤</span> By 阿林</a>
</div>
</footer>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script>
</div>
</div>
</body>
</html>