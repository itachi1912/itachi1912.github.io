<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>《高性能MySQL》读书笔记-2-Schema与数据类型优化1 | itachi's Blog</title><meta property="og:title" content="《高性能MySQL》读书笔记-2-Schema与数据类型优化1 - itachi's Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-07-28T00:00:00+08:00"><meta property="article:modified_time" content="2021-07-28T00:00:00+08:00"><meta name=Keywords content="Blog"><meta name=description content="《高性能MySQL》读书笔记-2-Schema与数据类型优化1"><meta name=author content="阿林"><meta property="og:url" content="https://itachi.xyz/post/high-performance-mysql-2.html"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://itachi.xyz>itachi's Blog</a><p class=description>昨夜梦 今辰你 明日思 | Blog about life and learning.</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://itachi.xyz>首页</a>
<a href=https://itachi.xyz/archives/ title=归档>归档</a>
<a href=https://itachi.xyz/about/ title=关于>关于</a>
<a href=https://itachi.xyz/tags/ title=标签>标签</a>
<a href=https://itachi.xyz/onenote/ title=一言>一言</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>《高性能MySQL》读书笔记-2-Schema与数据类型优化1</h1></header><date class="post-meta meta-date">2021年7月28日</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=/categories/technology>Technology</a></span></div><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><p>良好的逻辑设计和物理设计是高性能的基石，系统需根据要执行的查询语句来设计schema，其中反范式的设计可以加快某些类型的查询，但是可能导致一些类型的查询变慢。</p><blockquote><p>我之所谓生存，并不是苟活，所谓温饱，不是奢侈，所谓发展，也不是放纵。</p><p>&mdash; 鲁迅</p></blockquote><h2 id=1-选择优化的数据类型>1. 选择优化的数据类型</h2><p>选择合适数据类型的原则：</p><ul><li><p>更小的通常更好</p><p>一般情形下，尽量使用可以正确存储数据的最小数据类型，更小的数据类型占用更少的磁盘、内存、CPU缓存、更少的CPU周期。</p></li><li><p>简单就好</p><p>简单数据类型的操作通常需要更少的CPU周期。整型比字符串操作代价更低，字符串的字符集和校对规则要比整型的复杂。例如：使用内建的类型来存储时间；使用整型来存储IP值。</p></li><li><p>尽量避免NULL</p><p>通常情况最好指定列为not null，除非真的需要存储null值。可以为null的列使得索引、索引统计、值比较都变得更复杂。</p></li></ul><p>timestamp和datetime都可以存储时间和日期，并且精确到秒：其中timestamp只需要datetime一半的空间，但是timestamp允许的时间范围要小得多。</p><h3 id=11-整数类型>1.1 整数类型</h3><p>整数存储可以使用：tinyint,smallint,mediumint,int,bigint，他们分别使用8，16，24，32，64位存储空间。同时整数可选unsigned属性，表示正整数。这可以使得该类型的上限范围大概提高一倍。 整数计算一般使用64位的bigint整数。虽然MySQL可以为整数类型指定宽度，例如int(11)，但一般来说没有意义，他不会限制值的合法范围，只是规定了MySQL的一些交互工具显示字符的个数，对于存储和计算来说，int(1)和int(20)是相同的。</p><h3 id=12-实数类型>1.2 实数类型</h3><p>实数是带有小数的数字。float(4字节)和double(8字节)类型支持标准的浮点数运算，同时decimal支持更高精度的计算。需要指出，由于CPU不支持decimal的直接计算，decimal类型的计算是由MySQL核心服务实现的。因此，如非必要，使用原生浮点计算类型float和double会比decimal更快。使用浮点数时，建议只指定数据类型，不指定精度。MySQL使用double作为内部浮点计算的类型。</p><p>由于浮点数计算需要额外的空间和计算开销，所以尽量只在对小数进行计算时才使用decimal。数据量比较大的情况下，可以根据小数位数乘以相应倍数，使用bigint来存储，可以避免浮点数计算不精确和decimal计算代价高的问题。</p><h3 id=13-字符串类型>1.3 字符串类型</h3><h4 id=131-varchar>1.3.1 varchar</h4><p>varchar用于存储可变长字符串。他会使用额外的1到2个字节来存储字符串长度。varchar节省了空间，对性能有帮助，但是变长也带来了一些问题：update时字符串可能变长，这就需要额外的工作，比如，InnoDB可能会需要分裂页来让行可以放进页内。</p><p>合适的用varchar情况：</p><ol><li>字符串列的最大长度比平均值大的多，</li><li>列的更新少，碎片化不是问题；</li><li>使用了UTF-8这样复杂字符集的，每个字符都用不同的字节存储</li><li></li></ol><h4 id=132-char>1.3.2 char</h4><p>char是定长的，MySQL会根据定义的长度分配足够的空间，存储char值时，MySQL会删除字符串末尾空格，同时根据需要填充空格以方便比较。</p><p>适合char的情况：</p><ol><li>短的字符串，或者所有值都接近一个长度</li><li>经常变更的数据，char也比varchar更好，char不容易产生碎片</li></ol><p>比较短的列，char比varchar在存储空间上更有效率，比如char(1)存储Y和N，如果采用单字符集只需要一个字节，而varchar(1)需要2个字节，一个存值一个存长度。</p><h4 id=133--blob和text类型>1.3.3 blob和text类型</h4><p>很大数据数据可以使用blob或者text类型，blob类型使用二进制存储，他没有排序规则或字符集，而text使用字符方式，需要字符集和排序规则。</p><ul><li>blob类型：tinyblob，smallblob，blob，mediumblob，longblob</li><li>text类型：tinytext，smalltext，text，mediumtext，longtext</li></ul><p>MySQL把blob和text当作一个独立对象来存储，当值比较大时，InnoDB会使用外部区域来存储，同时每个值在行内需要1-4个字节存储一个指针，指向外部区域实际的值。</p><p>MySQL对blob和text列的排序：它只对每个列的最前max_sort_length个字节做排序，如果只需要排序一小部分可以减少max_sort_length的值，或者使用order by sustring(cloumn,length)。同时MySQL不会对blob和text全部长度的字符串做索引，也不能使用这些索引消除排序。</p><blockquote><p>如果Explain执行计划中的Extra列包含“Using temporary”,说明这个查询使用了隐式临时表</p></blockquote><h4 id=134-使用枚举代替字符串>1.3.4 使用枚举代替字符串</h4><p>枚举列可以把以一些不重复的字符串存储成一个预定义集合，MySQL会根据列表值的胡数量压缩到一个或者两个字节中，MySQL在内部会将值在列表中的位置保存为整数，在表的frm文件中保存"数字-字符串"映射关系的查找表：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>create</span> teable enum_test(
</span></span><span style=display:flex><span>	<span style=color:#f92672>-&gt;</span>  e ENUM(<span style=color:#e6db74>&#39;fish&#39;</span>,<span style=color:#e6db74>&#39;appale&#39;</span>,<span style=color:#e6db74>&#34;dog&#34;</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>-&gt;</span>);
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> enum_tes(e) <span style=color:#66d9ef>values</span>(<span style=color:#e6db74>&#39;fish&#39;</span>,<span style=color:#e6db74>&#39;dog&#39;</span>,<span style=color:#e6db74>&#39;appale&#39;</span>);
</span></span></code></pre></div><p>实际存储的时整数，可以在数字上下文环境检索：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> e <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>from</span> enum_test;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-----+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span>e <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>1</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>3</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>    <span style=color:#ae81ff>2</span><span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-----+
</span></span></span></code></pre></div><p>同时，枚举字段是按照内部存的整数而不是定义的字符串来排序的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> e  <span style=color:#66d9ef>from</span> enum_test;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> e     <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> fish  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> appale<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> dog   <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>-------+
</span></span></span></code></pre></div><h3 id=14-日期和时间类型>1.4 日期和时间类型</h3><p>MySQL提供两种日期类型：Datetime和Timestamp：</p><h4 id=141-datetime>1.4.1 Datetime</h4><p>​ Datetime可以保存从1001到9999年，精度为秒，封装到格式为yyyyMMddHHssmm的整数中，无时区，占用8个字节存储空间，MySQL以一种可排序的，无歧义的格式显示为“2021-07-30 14:58:15”。 datetime默认是not null。</p><h4 id=142-timestamp>1.4.2 timestamp</h4><p>timestamp保存了自1970年1月1的0点到现在的秒数，使用4个字节存储时间，只能表示1970年到2038年的时间。timestamp存储的时间与时区相关。默认值为当前时间。</p><p>原书作者建议：通常使用timestamp，他的空间效率更高，datetime用整数保存的时间不方便处理，所以推荐使用timestamp存储时间。</p><h3 id=15-位数据类型>1.5 位数据类型</h3><p>从技术上来说，位数据类型都是存储的字符串类型，非常迷惑的类型。</p><h4 id=151-bit>1.5.1 Bit</h4><p>可以用bit列存储一个或多个ture/false的值，bit(n)表示定义一个n个位的字段，n最大64。InnoBD给每个bit列使用一个足够存储的最小整数类型来存放，比如8位及以下就是1个字节，无法节省空间。</p><p>同时MySQL吧bit当作字符串类型，当然在数字计算时，结果时将字符串转为数据，相当迷惑，谨慎使用。</p><h4 id=152-set>1.5.2 Set</h4><p>需要保存多个true/false值时可以考虑合并到一个set数据类型，缺点是修改时需要alter table来实现。一般来说，set列无法使用索引。</p><p>一种代替set列的方式时使用一个整数包装一些列位，例如可以把8个位包装到一个tinyint中，并按位操作，可以弥补set列的修改问题，但是异常难以查询和理解，谨慎使用。</p><h3 id=16-选择标识符>1.6 选择标识符</h3><p>给标识列选择合适的数据类型，关联时标识列需要用来比较，也可能在其他表中作为外键使用。</p><p>整数通常是标识列最好的选择，速度块，并且可以使用auto_increment。尽量避免使用字符串类型，比较消耗空间，并且不如整数快。同时更要避免随机字符串，随机的字符串会导致数据任意分布在很大空间内，导致insert和select语句变慢：</p><ul><li>insert变慢：插入值会随机的写到索引的不同位置出，同时会导致页分裂，磁盘随机访问，已经对于聚簇索引产生碎片。</li><li>select语句变慢：逻辑相邻的两条记录被分布在不同的磁盘和索引处。不利于查询。</li><li>随机值导致访问的局部性原理失效，整个数据集都是热点数据，那么缓存将无意义。</li></ul><p>如果使用UUID时应该去掉‘-’符号，更好的做法是，用unhex()函数将uuid转为16字节的数据，并存储在binary(16)列中。检索时可以用hex()函数转为数字在检索。即便如此，还是不如递增的整数好用。</p><h3 id=17-特殊类型>1.7 特殊类型</h3><p>一个重要例子是很多人使用varchar(15)列来存储IP值。实际上IP值是32位无符号整数，不是字符串。建议使用无符号整数存储IP值，MySQL提供INET_ATON()和INET_NTOA()函数在数值IP和点分IP之间转换。</p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://itachi.xyz>阿林</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://itachi.xyz/post/high-performance-mysql-2.html>https://itachi.xyz/post/high-performance-mysql-2.html</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br><div class=post-archive></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=/tags/%E9%AB%98%E6%80%A7%E8%83%BDmysql>高性能MySQL</a></li><li><a href=/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0>读书笔记</a></li></ul></div></article><div id=gitalk-container></div><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script>
<script>var gitalk=new Gitalk({id:decodeURI(window.location.pathname),clientID:"30ffb17e5ccaa5f1830e",clientSecret:"67ba9ccd9df5c8f402f46b2462f09d644219c04f",repo:"itachi1912.github.io",owner:"itachi1912",admin:["itachi1912"],labels:["gitment"],perPage:25});gitalk.render("gitalk-container")</script></div></div><div id=secondary><section class=widget><form id=search action=https://itachi.xyz/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://itachi.xyz>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list><li><a href=https://itachi.xyz/categories/life/>Life (10)</a></li><li><a href=https://itachi.xyz/categories/technology/>Technology (15)</a></li><li><a href=https://itachi.xyz/categories/weekly/>Weekly (2)</a></li></ul></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://itachi.xyz/post/miui-root.html title=MIUI安装Magisk获取ROOT>MIUI安装Magisk获取ROOT</a></li><li><a href=https://itachi.xyz/post/talk-about-legend.html title="<张捷评联想>系列视频">&lt;张捷评联想>系列视频</a></li><li><a href=https://itachi.xyz/post/peaceful-evolution.html title=张捷：从网约车谈田氏代齐式的和平演变>张捷：从网约车谈田氏代齐式的和平演变</a></li><li><a href=https://itachi.xyz/post/ostep-04.html title=OSTEP-4(抽象：进程)>OSTEP-4(抽象：进程)</a></li><li><a href=https://itachi.xyz/post/weekly-002.html title=生活周刊(第2期)：南京大屠杀幸存者黄刘氏去世>生活周刊(第2期)：南京大屠杀幸存者黄刘氏去世</a></li><li><a href=https://itachi.xyz/post/weekly-001.html title=生活周刊(第1期)：缅怀先辈，铭记历史，吾辈自强！>生活周刊(第1期)：缅怀先辈，铭记历史，吾辈自强！</a></li><li><a href=https://itachi.xyz/post/auto-update-geoip-site.html title=自动更新VV配置文件>自动更新VV配置文件</a></li><li><a href=https://itachi.xyz/post/how-to-fight-boredom.html title=如何对抗无聊，培养属于自己的生活兴趣>如何对抗无聊，培养属于自己的生活兴趣</a></li><li><a href=https://itachi.xyz/post/mount-aliyun-disk-to-local.html title=把阿里云盘挂载到本地使用>把阿里云盘挂载到本地使用</a></li><li><a href=https://itachi.xyz/post/get-offer-01.html title=剑指offer计划>剑指offer计划</a></li></ul></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://www.acdiao.com title=AC的简单博客>AC的简单博客</a></li><li><a target=_blank href=https://img.tujidu.com title=AC大佬的图床>AC大佬的图床</a></li><li><a target=_blank href=https://blog.cetcweb.cn/ title=记录实验过程>记录实验过程</a></li><li><a target=_blank href=https://qitablog.com/ title=奇它博客>奇它博客</a></li><li><a target=_blank href=http://laihongquan.com/ title=Ezio>Ezio</a></li><li><a target=_blank href=https://luckly.work/ title=早起的年轻人>早起的年轻人</a></li><li><a target=_blank href=https://geshanzsq.com title=格姗知识圈>格姗知识圈</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://itachi.xyz/index.xml>文章 RSS</a></li></ul></section></div></div><footer id=footer><div style=font-size:.7em>Powered by <a href=https://gohugo.io/ target=_black rel=nofollow>Hugo</a>
and
Theme Based On <a href=https://www.flysnow.org/ target=_black>飞雪无情</a></div><br><div style=font-size:.7em>&copy; 2022 Made with <span style=color:red>❤</span> By 阿林</a></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src="/js/totop.js?v=0.0.0" async></script>
<script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script></div></div></body></html>